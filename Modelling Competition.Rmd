---
title: "Modelling Competition: House Prices"
author: 
- Roberto Alvarez Llordachs
- Javier Goñi Artieda
- Marcos Crespo Díaz
- Gabriela Levenfeld Sabau
- Sofía Gianelli Nan
- Miguel Díaz-Plaza Cabrera
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: yes
    toc_depth: 4
    number_sections: yes
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

House prices have sparked lot of debate recently in our society. Currently, this topic has aroused controversy on the grounds that has been a cornerstone in 2008 crisis. Were buyers to decide a model for setting the selling price, which factors would be included and what would be their weight?

The goal of this project is to create a effective price prediction model.


# Data Preparation

First step would be to load both databases, train and test.

```{r}
train <- read.csv("train.csv", sep=",")
test <- read.csv("test.csv", sep=",")

column_diff <- setdiff(names(train), names(test))
```

```{r}
# In order to visualize the data
rmarkdown::paged_table(train)
rmarkdown::paged_table(test)
summary(train)
```

We can see that train contain one more column than test, this extra column is `r column_diff`.
```{r}
# Ordenar las columnas por tipo de variable (Las 25 primeras son continuas)
train <- train[,c(1,81,4,5,20,21,27,35,37,38,39,44,45,46,47,60,63,67,68,69,70,71,72,76,78,2,3,6,7,8,9,10,11,12,13,14,15,16,17,18,19,22,23,24,25,26,28,29,30,31,32,33,34,36,40,41,42,43,48,49,50,51,52,53,54,55,56,57,58,59,61,62,64,65,66,73,74,75,77,79,80)]

test <- test[,c(1,4,5,20,21,27,35,37,38,39,44,45,46,47,60,63,67,68,69,70,71,72,76,78,2,3,6,7,8,9,10,11,12,13,14,15,16,17,18,19,22,23,24,25,26,28,29,30,31,32,33,34,36,40,41,42,43,48,49,50,51,52,53,54,55,56,57,58,59,61,62,64,65,66,73,74,75,77,79,80)]
```
The data set collects 2919 observations of different features of residential houses in Ames, Iowa. The number of features is given by the number of columns of the test dataset, minus the first column that is irrelevant as it include the number of the observation.

```{r}
# Eliminate the ID columns
train <- train[,-1]
test <- test[,-1]
```

Miro cuántos NAs hay en cada varibales para ver si puedo quitar algún feature así de primeras.

```{r}
n_rows <- nrow(train)
# Counting NA: TRAIN y expresado en %
(colSums(is.na(train))/nrow(train))*100
```
```{r}
# Counting NA: TEST y expresado en %
(colSums(is.na(test))/nrow(train))*100
```
Conclusión?

Id, hay que quitarla pero a la espera de si se pueden juntar los datasets o no.
Variables que hay que eliminar 100% (su % de missing values es altísimo)
-   Alley, con un 93% (train) y un 92% (test)
-   PoolQC (Pool quality)
-   Fence (Fence quality)
-   MiscFeature (Miscellaneous feature not covered in other categories)

Aaproximadamente el 50% son missing values:
Quizás sería buena hacer un análisis más profundo, para ver cuánto de significativa es la variable.
-   FireplaceQu (Fireplace quality)

Ahora, rearrange the dataset and delete the 4 variables because they have a high number of missing values.

```{r}
# Ordenar dataset: primero continuas y  luego categoricas
train <- train[,c(1,81,4,5,20,21,27,35,37,38,39,44,45,46,47,60,63,67,68,69,70,71,72,76,78,2,3,6,7,8,9,10,11,12,13,14,15,16,17,18,19,22,23,24,25,26,28,29,30,31,32,33,34,36,40,41,42,43,48,49,50,51,52,53,54,55,56,57,58,59,61,62,64,65,66,73,74,75,77,79,80)]

# Eliminar: Alley, PoolQC, Fence y MiscFeature
train <- train[,-c(29,76,77,78)]
```

A continuación, el objetivo es pasar las variables categóricas a factor para poder trabajar con ellas. Y ver el número de observaciones que tenemos para cada una de los posibles valores de las categorías.

```{r}
train <- train %>% mutate_if(~is.character(.), ~as.factor(.))

train$OverallQual <- factor(train$OverallQual)
train$OverallCond <- factor(train$OverallCond)
train$MSSubClass <- factor(train$MSSubClass)

print(class(train$OverallQual))
print(class(train$OverallCond))
print(class(train$MSSubClass))
```

```{r}
library(dplyr)

# Lista de columnas categóricas
columnas_categoricas <- colnames(train)[sapply(train, is.factor)]
columnas_categoricas

tablas_frecuencia <- list()

#INTENTO 1
# Iterar sobre cada columna categórica y crear la tabla de frecuencia
for (col in columnas_categoricas) {
  tablas_frecuencia[[col]] <- table(train[[col]])
}

# Mostrar las tablas de frecuencia
tablas_frecuencia

```

Mismo procedimiento para el test dataset.
Then, we should check if the categorical variables are correctly defined as factors. For those variables whose categories are define with characters and those whose categories are defined as numbers (MSSubClass, OverallQual, OverallCond, currently defined as integers).

```{r}
test <- test %>% mutate_if(~is.character(.), ~as.factor(.))

test$OverallQual <- factor(test$OverallQual)
test$OverallCond <- factor(test$OverallCond)
test$MSSubClass <- factor(test$MSSubClass)


# Lista de columnas categóricas
columnas_categoricas <- colnames(test)[sapply(test, is.factor)]
columnas_categoricas

tablas_frecuencia <- list()

# Iterar sobre cada columna categórica y crear la tabla de frecuencia
for (col in columnas_categoricas) {
  tablas_frecuencia[[col]] <- table(test[[col]])
}

# Mostrar las tablas de frecuencia
tablas_frecuencia
```


```{r}
library(dplyr)

# Lista de variables categóricas
variables_categoricas <- c("MSSubClass", "MSZoning", "Street", "Alley", "LotShape", "LandContour",
                            "Utilities", "LotConfig", "LandSlope", "Neighborhood", "Condition1",
                            "Condition2", "BldgType", "HouseStyle", "OverallQual", "OverallCond",
                            "RoofStyle", "RoofMatl", "Exterior1st", "Exterior2nd", "MasVnrType",
                            "ExterQual", "ExterCond", "Foundation", "BsmtQual", "BsmtCond",
                            "BsmtExposure", "BsmtFinType1", "BsmtFinType2", "Heating", "HeatingQC",
                            "CentralAir", "Electrical", "KitchenQual", "Functional", "FireplaceQu",
                            "GarageType", "GarageFinish", "GarageQual", "GarageCond", "PavedDrive",
                            "PoolQC", "Fence", "MiscFeature", "SaleType", "SaleCondition")

# Función para obtener el conteo de observaciones para cada variable categórica
obtener_conteo <- function(df, var) {
  conteo <- df %>% count({{ var }})
  print(conteo)
}

# Obtener el conteo de observaciones para cada variable categórica
for (variable in variables_categoricas) {
  obtener_conteo(train, !!as.name(variable))
}
```

```{r}
umbral <- 2 # Definir el umbral mínimo de instancias

# Lista de columnas categóricas
columnas_categoricas <- colnames(train)[sapply(train, is.factor)]

# Iterar sobre cada columna categórica y conservar las categorías con más de 'umbral' instancias
for (col in columnas_categoricas) {
  filtro <- train %>% count(!!sym(col)) %>% filter(n > umbral)
  train <- train[train[[col]] %in% filtro[[col]], ]
  train[[col]] <- factor(train[[col]], levels = unique(train[[col]]))
}

# Mostrar las categorías conservadas en cada columna categórica
for (col in columnas_categoricas) {
  cat(paste("Columna:", col, "\n"))
  print(table(train[[col]]))
}
```


# Exploratory Analysis

In the first part, we will carry out a descriptive analysis of several variables to understand them better. Graphs will help us to reach this goal, histograms for continuous variables and box-plots for categorical variables.

```{r}
hist(train$variable, bins = 10)
```

```{r}
plot1 <-
  ggplot(train, aes(LotFrontage)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Linear feet of street connected to property")
plot2 <-
  ggplot(train, aes(LotArea)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Lot size in square feet ")
plot3 <-
  ggplot(train, aes(YearBuilt)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Original construction date")
plot4 <-
  ggplot(train, aes(YearRemodAdd)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Remodel date")
plot5 <-
  ggplot(train, aes(MasVnrArea)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Masonry veneer area")
plot6 <-
  ggplot(train, aes(BsmtFinSF1)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Type 1 finished square feet")
plot7 <-
  ggplot(train, aes(BsmtFinSF2)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Type 2 finished square feet")
plot8 <-
  ggplot(train, aes(BsmtUnfSF)) + geom_histogram(fill = "lightblue",  bins = 10) + labs(title ="Unfinished sq feet of basement area")
plot9 <-
  ggplot(train, aes(TotalBsmtSF)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Total sq feet of basement area")
plot10 <-
  ggplot(train, aes(X1stFlrSF)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="1st Floor sq feet")
plot11 <-
  ggplot(train, aes(X2ndFlrSF)) + geom_histogram(fill = "lightblue",  bins = 10) + labs(title ="2nd floor sq feet ")
plot12 <-
  ggplot(train, aes(LowQualFinSF)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Low quality finished sq feet")
plot13 <-
  ggplot(train, aes(GrLivArea)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Above grade living area sq feet")
plot14 <-
  ggplot(train, aes(GarageYrBlt)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Year garage was built")
plot15 <-
  ggplot(train, aes(GarageArea)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Size of garage in sq feet ")
plot16 <-
  ggplot(train, aes(WoodDeckSF)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Wood deck area in sq feet ")
plot17 <-
  ggplot(train, aes(OpenPorchSF)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Open porch area in sq feet")
plot18 <-
  ggplot(train, aes(EnclosedPorch)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Enclosed porch area in sq feet")
plot19 <-
  ggplot(train, aes(X3SsnPorch)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="3 season porch area in sq feet")
plot20 <-
  ggplot(train, aes(ScreenPorch)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Screen porch area in sq feet")
plot21 <-
  ggplot(train, aes(PoolArea)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Pool area in sq feet")
plot22 <-
  ggplot(train, aes(MiscVal)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="$Value of miscellaneous feature")
plot23 <-
  ggplot(train, aes(YrSold)) + geom_histogram(fill = "lightblue", bins = 10) + labs(title ="Year Sold")

grid.arrange(
  plot1,
  plot2,
  plot3,
  plot4,
  plot5,
  plot6,
  plot7,
  plot8,
  plot9,
  plot10,
  plot11,
  plot12,
  plot13,
  plot14,
  plot15,
  plot16,
  plot17,
  plot18,
  plot19,
  plot20,
  plot21,
  plot22,
  plot23,
  ncol = 3,
  top = "Histograms"
)
```



Moreover, summary statistics are a useful tool for analyzing continuous variables.

```{r}
measures <- function(x){
  c(mean(x), median(x), mode(x), var(x), sd(x), skew(x), kurtosi(x))
}
```



Ideas en base a Lab1:

- Data preprocessing: Remove unnecesary columns such as ID, in Lab1 remove characteristics with one observation. Check that categorical variables are factors. Check summary to check everything is correct.

- After datapreprocessing do Exploratory analysis: Correlations (ggpairs, in Lab 2 values and colors), histograms of predictors, plots of response vs some predictors (only comment important ones)

- Modeling: regsubsets only when continuous, Lab1 use stepAIC... Check model assumptions.

- Prediction


